<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è€å¸ˆç­¾åˆ°ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; }
        body { background: linear-gradient(135deg, #2c3e50, #3498db); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); overflow: hidden; }
        .header { background: #3498db; color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 32px; margin-bottom: 10px; }
        .content { padding: 30px; }
        .panel { background: #f8f9fa; padding: 25px; border-radius: 15px; border-left: 5px solid #3498db; margin-bottom: 25px; }
        .panel h2 { color: #2c3e50; margin-bottom: 20px; font-size: 24px; display: flex; align-items: center; }
        .panel h2 i { margin-right: 10px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        input, select { width: 100%; padding: 12px; border: 2px solid #e1e5ee; border-radius: 8px; font-size: 16px; }
        input:focus, select:focus { border-color: #3498db; outline: none; }
        button { background: #3498db; color: white; border: none; padding: 12px 25px; border-radius: 8px; font-size: 16px; cursor: pointer; margin-right: 10px; margin-bottom: 10px; transition: all 0.3s; }
        button:hover { background: #2980b9; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        button.secondary { background: #95a5a6; }
        button.secondary:hover { background: #7f8c8d; }
        button.success { background: #27ae60; }
        button.success:hover { background: #219653; }
        button.danger { background: #e74c3c; }
        button.danger:hover { background: #c0392b; }
        .records { max-height: 400px; overflow-y: auto; }
        .record-item { background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #27ae60; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .record-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .student-info { font-weight: bold; color: #2c3e50; }
        .timestamp { color: #7f8c8d; font-size: 12px; }
        .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1); transition: transform 0.3s; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-number { font-size: 32px; font-weight: bold; color: #3498db; margin-bottom: 5px; }
        .stat-label { color: #7f8c8d; font-size: 14px; }
        .instructions { background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin-top: 20px; }
        .student-list-section { margin-top: 20px; }
        .student-list { max-height: 300px; overflow-y: auto; margin-top: 10px; border: 1px solid #e1e5ee; border-radius: 8px; }
        .student-item { background: white; padding: 12px; margin-bottom: 0; border-bottom: 1px solid #e1e5ee; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s; }
        .student-item:hover { background: #f1f8ff; }
        .student-item:last-child { border-bottom: none; }
        .student-details { flex: 1; }
        .student-actions { display: flex; gap: 5px; }
        .import-section { background: #e8f5e8; border: 1px solid #c8e6c9; border-radius: 8px; padding: 15px; margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
        .absence { color: #e74c3c; font-weight: bold; }
        .not-class { color: #95a5a6; font-weight: bold; }
        .flex-row { display: flex; gap: 15px; }
        .flex-row .form-group { flex: 1; }
        .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; }
        .file-input-wrapper input[type=file] { position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
        .file-input-label { display: inline-block; padding: 10px 15px; background: #3498db; color: white; border-radius: 5px; cursor: pointer; }
        .file-input-label:hover { background: #2980b9; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 25px; border-radius: 10px; width: 90%; max-width: 500px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 20px; font-weight: bold; }
        .close-modal { background: none; border: none; font-size: 24px; cursor: pointer; color: #7f8c8d; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        @media (max-width: 768px) {
            .stats { grid-template-columns: 1fr; }
            .flex-row { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š è€å¸ˆç­¾åˆ°ç®¡ç†ç³»ç»Ÿ</h1>
            <p>è®¾ç½®ç­¾åˆ°è§„åˆ™ã€ç®¡ç†å­¦ç”Ÿåå•ã€æŸ¥çœ‹ç­¾åˆ°è®°å½•</p>
        </div>
        
        <div class="content">
            <!-- ç­¾åˆ°è®¾ç½® -->
            <div class="panel">
                <h2><i>âš™ï¸</i> ç­¾åˆ°è®¾ç½®</h2>
                <div class="form-group">
                    <label for="instructionPattern">ç‰¹æ®ŠæŒ‡ä»¤æ ¼å¼</label>
                    <input type="text" id="instructionPattern" value="å­¦å·+X" placeholder="ä¾‹å¦‚ï¼šå­¦å·+X æˆ– \"å­¦å·\"+X">
                    <small style="color: #7f8c8d; margin-top: 5px; display: block;">
                        æç¤ºï¼šä¸å¸¦å¼•å·çš„æ±‰å­—è¡¨ç¤ºå­¦ç”Ÿåªéœ€å¡«å†™å¯¹åº”æ±‰å­—ï¼Œå¸¦å¼•å·çš„æ±‰å­—è¡¨ç¤ºå¿…é¡»ä¸è¡¨æ ¼ä¿¡æ¯ä¸€è‡´
                    </small>
                </div>
                
                <div class="form-group">
                    <label for="randomValue">éšæœºå€¼ (X)</label>
                    <div class="flex-row">
                        <input type="text" id="randomValue" value="2024" placeholder="å¯æ‰‹åŠ¨è¾“å…¥æˆ–è‡ªåŠ¨ç”Ÿæˆ">
                        <button onclick="generateRandomValue()">è‡ªåŠ¨ç”Ÿæˆ</button>
                    </div>
                </div>
                
                <div class="instructions">
                    <strong>å½“å‰æŒ‡ä»¤ç¤ºä¾‹ï¼š</strong><br>
                    å­¦ç”Ÿéœ€è¦è¾“å…¥ï¼š<span id="instructionExample">å­¦å·2024</span>
                </div>
                
                <div style="margin-top: 20px;">
                    <button onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
                    <button onclick="resetSettings()" class="secondary">é‡ç½®</button>
                </div>
            </div>
            
            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalSignins">0</div>
                    <div class="stat-label">æ€»ç­¾åˆ°äººæ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="todaySignins">0</div>
                    <div class="stat-label">ä»Šæ—¥ç­¾åˆ°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="studentCount">0</div>
                    <div class="stat-label">ç­çº§äººæ•°</div>
                </div>
            </div>
            
            <!-- ç­¾åˆ°è®°å½• -->
            <div class="panel">
                <h2><i>ğŸ“‹</i> ç­¾åˆ°è®°å½•</h2>
                <div style="margin-bottom: 15px;">
                    <button onclick="refreshRecords()">åˆ·æ–°è®°å½•</button>
                    <button onclick="exportRecords()" class="success">ğŸ“¤ å¯¼å‡ºæ•°æ® (Excel)</button>
                    <button onclick="clearRecords()" class="secondary">æ¸…ç©ºè®°å½•</button>
                </div>
                
                <div class="records" id="recordsList">
                    <!-- ç­¾åˆ°è®°å½•å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
            
            <!-- ç­çº§åå•ç®¡ç† -->
            <div class="panel">
                <h2><i>ğŸ‘¥</i> ç­çº§åå•ç®¡ç†</h2>
                
                <div class="import-section">
                    <div class="file-input-wrapper">
                        <button class="file-input-label">ğŸ“¥ å¯¼å…¥å­¦ç”Ÿåå•</button>
                        <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" onchange="importFromFile()">
                    </div>
                    <button onclick="loadExampleList()" class="secondary">ğŸ“‹ ç¤ºä¾‹åå•</button>
                    <button onclick="exportStudentList()" class="secondary">ğŸ“¤ å¯¼å‡ºåå•</button>
                    <button onclick="clearStudentList()" class="secondary">ğŸ—‘ï¸ æ¸…ç©ºåå•</button>
                </div>
                
                <div class="student-list-section">
                    <h3>å½“å‰å­¦ç”Ÿåå•</h3>
                    <div class="student-list" id="studentList">
                        <!-- å­¦ç”Ÿåå•å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                    <div style="margin-top: 10px;">
                        <button onclick="addStudentManually()" class="secondary">â• æ‰‹åŠ¨æ·»åŠ å­¦ç”Ÿ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘å­¦ç”Ÿä¿¡æ¯æ¨¡æ€æ¡† -->
    <div class="modal" id="editStudentModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ç¼–è¾‘å­¦ç”Ÿä¿¡æ¯</div>
                <button class="close-modal" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="form-group">
                <label for="editStudentId">å­¦å·</label>
                <input type="text" id="editStudentId">
            </div>
            <div class="form-group">
                <label for="editStudentName">å§“å</label>
                <input type="text" id="editStudentName">
            </div>
            <div class="form-group">
                <label for="editStudentClass">ç­çº§</label>
                <input type="text" id="editStudentClass">
            </div>
            <div class="modal-footer">
                <button onclick="closeEditModal()" class="secondary">å–æ¶ˆ</button>
                <button onclick="saveStudentEdit()" class="success">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥SheetJSåº“ç”¨äºå¯¼å‡ºExcel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <script>
        // ç¤ºä¾‹å­¦ç”Ÿåå•æ•°æ®
        const exampleStudentList = [
            { studentId: "3240111003", name: "å†¯å¤©ç¾½", className: "æ241" },
            { studentId: "3240111015", name: "å¼ ç´«ç‡•", className: "æ241" },
            { studentId: "3240111009", name: "è‘£ç‰è¹", className: "æ241" },
            { studentId: "3240111017", name: "åˆ˜æ˜Ÿé“", className: "æ241" },
            { studentId: "3240111018", name: "æœ±å¦", className: "æ241" },
            { studentId: "3240111039", name: "ç‹å®‡å½¤", className: "æ242" },
            { studentId: "3240111028", name: "å¼ è…¾é£", className: "æ242" },
            { studentId: "3240111044", name: "è¢æ¢¦", className: "æ242" },
            { studentId: "3240111040", name: "åˆ˜é™æ€¡", className: "æ242" },
            { studentId: "3240111030", name: "èµµé›…æ¥ ", className: "æ242" }
        ];
        
        let settings = JSON.parse(localStorage.getItem('teacherSettings')) || {
            instructionPattern: "å­¦å·+X",
            randomValue: "2024"
        };
        
        let records = JSON.parse(localStorage.getItem('signinRecords')) || [];
        let studentList = JSON.parse(localStorage.getItem('studentList')) || [];
        let currentEditIndex = -1;

        function init() {
            document.getElementById('instructionPattern').value = settings.instructionPattern;
            document.getElementById('randomValue').value = settings.randomValue;
            updateInstructionExample();
            updateStats();
            displayRecords();
            displayStudentList();
        }
        
        function importFromFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    
                    // æ™ºèƒ½è¯†åˆ«è¡¨æ ¼ç»“æ„
                    const processedData = processExcelData(jsonData);
                    
                    if (processedData.length > 0) {
                        studentList = processedData;
                        localStorage.setItem('studentList', JSON.stringify(studentList));
                        displayStudentList();
                        updateStats();
                        alert(`æˆåŠŸå¯¼å…¥ ${studentList.length} åå­¦ç”Ÿ`);
                    } else {
                        alert('æ–‡ä»¶å†…å®¹æ ¼å¼ä¸æ­£ç¡®æˆ–ä¸ºç©º');
                    }
                } catch (error) {
                    console.error(error);
                    alert('æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼');
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function processExcelData(data) {
            if (!data || data.length === 0) return [];
            
            // æŸ¥æ‰¾ç­çº§ã€å§“åã€å­¦å·åˆ—çš„ä½ç½®
            let classCol = -1, nameCol = -1, idCol = -1;
            
            // æ£€æŸ¥ç¬¬ä¸€è¡Œï¼ˆæ ‡é¢˜è¡Œï¼‰
            const headerRow = data[0];
            for (let i = 0; i < headerRow.length; i++) {
                const cell = String(headerRow[i]).trim();
                if (cell.includes('ç­') || cell.includes('class') || cell.includes('Class')) {
                    classCol = i;
                } else if (cell.includes('å§“å') || cell.includes('name') || cell.includes('Name')) {
                    nameCol = i;
                } else if (cell.includes('å­¦å·') || cell.includes('id') || cell.includes('ID') || cell.includes('å­¦å·')) {
                    idCol = i;
                }
            }
            
            // å¦‚æœæ²¡æ‰¾åˆ°æ ‡é¢˜è¡Œï¼Œå°è¯•ç¬¬äºŒè¡Œ
            if (classCol === -1 && nameCol === -1 && idCol === -1 && data.length > 1) {
                const secondRow = data[1];
                for (let i = 0; i < secondRow.length; i++) {
                    const cell = String(secondRow[i]).trim();
                    if (cell.includes('ç­') || cell.includes('class') || cell.includes('Class')) {
                        classCol = i;
                    } else if (cell.includes('å§“å') || cell.includes('name') || cell.includes('Name')) {
                        nameCol = i;
                    } else if (cell.includes('å­¦å·') || cell.includes('id') || cell.includes('ID') || cell.includes('å­¦å·')) {
                        idCol = i;
                    }
                }
            }
            
            // å¦‚æœè¿˜æ˜¯æ²¡æ‰¾åˆ°ï¼Œä½¿ç”¨é»˜è®¤ä½ç½®
            if (classCol === -1) classCol = 0;
            if (nameCol === -1) nameCol = 1;
            if (idCol === -1) idCol = 2;
            
            // å¤„ç†æ•°æ®è¡Œ
            const result = [];
            const startRow = (headerRow && headerRow.some(cell => String(cell).includes('ç­') || 
                String(cell).includes('å§“å') || String(cell).includes('å­¦å·'))) ? 1 : 0;
            
            for (let i = startRow; i < data.length; i++) {
                const row = data[i];
                if (row && row.length > Math.max(classCol, nameCol, idCol)) {
                    const className = String(row[classCol] || '').trim();
                    const name = String(row[nameCol] || '').trim();
                    const studentId = String(row[idCol] || '').trim();
                    
                    // è·³è¿‡ç©ºè¡Œ
                    if (className || name || studentId) {
                        result.push({
                            studentId: studentId,
                            name: name,
                            className: className
                        });
                    }
                }
            }
            
            return result;
        }
        
        function loadExampleList() {
            if (confirm('æ˜¯å¦åŠ è½½ç¤ºä¾‹åå•ï¼Ÿè¿™å°†æ›¿æ¢å½“å‰åå•ã€‚')) {
                studentList = [...exampleStudentList];
                localStorage.setItem('studentList', JSON.stringify(studentList));
                displayStudentList();
                updateStats();
                alert('ç¤ºä¾‹åå•å·²åŠ è½½');
            }
        }
        
        function clearStudentList() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºå­¦ç”Ÿåå•å—ï¼Ÿ')) {
                studentList = [];
                localStorage.setItem('studentList', JSON.stringify(studentList));
                displayStudentList();
                updateStats();
                alert('å­¦ç”Ÿåå•å·²æ¸…ç©º');
            }
        }
        
        function displayStudentList() {
            const studentListElement = document.getElementById('studentList');
            
            if (studentList.length === 0) {
                studentListElement.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">æš‚æ— å­¦ç”Ÿåå•ï¼Œè¯·å…ˆå¯¼å…¥</p>';
                return;
            }
            
            // æŒ‰ç­çº§ã€å§“åã€å­¦å·æ’åº
            studentList.sort((a, b) => {
                if (a.className !== b.className) return a.className.localeCompare(b.className);
                if (a.name !== b.name) return a.name.localeCompare(b.name);
                return a.studentId.localeCompare(b.studentId);
            });
            
            studentListElement.innerHTML = studentList.map((student, index) => `
                <div class="student-item" onclick="editStudent(${index})">
                    <div class="student-details">
                        <strong>${student.studentId}</strong> - ${student.name} (${student.className})
                    </div>
                    <div class="student-actions">
                        <button class="secondary" onclick="event.stopPropagation(); deleteStudent(${index})">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }
        
        function editStudent(index) {
            currentEditIndex = index;
            const student = studentList[index];
            document.getElementById('editStudentId').value = student.studentId;
            document.getElementById('editStudentName').value = student.name;
            document.getElementById('editStudentClass').value = student.className;
            document.getElementById('editStudentModal').style.display = 'flex';
        }
        
        function closeEditModal() {
            document.getElementById('editStudentModal').style.display = 'none';
            currentEditIndex = -1;
        }
        
        function saveStudentEdit() {
            if (currentEditIndex === -1) return;
            
            const studentId = document.getElementById('editStudentId').value;
            const name = document.getElementById('editStudentName').value;
            const className = document.getElementById('editStudentClass').value;
            
            if (!studentId || !name || !className) {
                alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
                return;
            }
            
            // æ£€æŸ¥å­¦å·æ˜¯å¦é‡å¤ï¼ˆæ’é™¤å½“å‰ç¼–è¾‘çš„å­¦ç”Ÿï¼‰
            const duplicate = studentList.some((student, index) => 
                index !== currentEditIndex && student.studentId === studentId
            );
            
            if (duplicate) {
                alert('è¯¥å­¦å·å·²å­˜åœ¨ï¼');
                return;
            }
            
            studentList[currentEditIndex] = { studentId, name, className };
            localStorage.setItem('studentList', JSON.stringify(studentList));
            displayStudentList();
            closeEditModal();
            alert('å­¦ç”Ÿä¿¡æ¯æ›´æ–°æˆåŠŸï¼');
        }
        
        function deleteStudent(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™åå­¦ç”Ÿå—ï¼Ÿ')) {
                studentList.splice(index, 1);
                localStorage.setItem('studentList', JSON.stringify(studentList));
                displayStudentList();
                updateStats();
                alert('å­¦ç”Ÿåˆ é™¤æˆåŠŸï¼');
            }
        }
        
        function addStudentManually() {
            const studentId = prompt('è¯·è¾“å…¥å­¦å·ï¼š');
            if (!studentId) return;
            
            const name = prompt('è¯·è¾“å…¥å§“åï¼š');
            if (!name) return;
            
            const className = prompt('è¯·è¾“å…¥ç­çº§ï¼š');
            if (!className) return;
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            const exists = studentList.some(student => 
                student.studentId === studentId
            );
            
            if (exists) {
                alert('è¯¥å­¦å·å·²å­˜åœ¨ï¼');
                return;
            }
            
            studentList.push({ studentId, name, className });
            localStorage.setItem('studentList', JSON.stringify(studentList));
            displayStudentList();
            updateStats();
            alert('å­¦ç”Ÿæ·»åŠ æˆåŠŸï¼');
        }
        
        function exportStudentList() {
            if (studentList.length === 0) {
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„å­¦ç”Ÿåå•');
                return;
            }
            
            const csvContent = "data:text/csv;charset=utf-8," 
                + "å­¦å·,å§“å,ç­çº§\n"
                + studentList.map(student => 
                    `${student.studentId},${student.name},${student.className}`
                ).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "å­¦ç”Ÿåå•.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function generateRandomValue() {
            settings.randomValue = Math.floor(1000 + Math.random() * 9000).toString();
            document.getElementById('randomValue').value = settings.randomValue;
            updateInstructionExample();
            saveSettings();
        }
        
        function updateInstructionExample() {
            const pattern = document.getElementById('instructionPattern').value;
            const example = pattern.replace('X', settings.randomValue);
            document.getElementById('instructionExample').textContent = example;
        }
        
        function saveSettings() {
            settings.instructionPattern = document.getElementById('instructionPattern').value;
            settings.randomValue = document.getElementById('randomValue').value;
            localStorage.setItem('teacherSettings', JSON.stringify(settings));
            updateInstructionExample();
            alert('è®¾ç½®å·²ä¿å­˜ï¼');
        }
        
        function resetSettings() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰è®¾ç½®å—ï¼Ÿ')) {
                settings = { instructionPattern: "å­¦å·+X", randomValue: "2024" };
                localStorage.setItem('teacherSettings', JSON.stringify(settings));
                init();
            }
        }
        
        function updateStats() {
            const total = records.length;
            const today = records.filter(record => {
                return new Date(record.timestamp).toDateString() === new Date().toDateString();
            }).length;
            
            document.getElementById('totalSignins').textContent = total;
            document.getElementById('todaySignins').textContent = today;
            document.getElementById('studentCount').textContent = studentList.length;
        }
        
        function displayRecords() {
            const recordsList = document.getElementById('recordsList');
            
            if (records.length === 0) {
                recordsList.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">æš‚æ— ç­¾åˆ°è®°å½•</p>';
                return;
            }
            
            // æŒ‰æ—¶é—´å€’åºæ’åˆ—
            const sortedRecords = [...records].sort((a, b) => 
                new Date(b.timestamp) - new Date(a.timestamp)
            );
            
            recordsList.innerHTML = sortedRecords.map(record => `
                <div class="record-item">
                    <div class="record-header">
                        <span class="student-info">${record.name} (${record.studentId}) - ${record.className}</span>
                        <span class="timestamp">${new Date(record.timestamp).toLocaleString()}</span>
                    </div>
                    <div style="color: #27ae60; font-size: 12px;">âœ… ç­¾åˆ°æˆåŠŸ</div>
                </div>
            `).join('');
        }
        
        function refreshRecords() {
            records = JSON.parse(localStorage.getItem('signinRecords')) || [];
            updateStats();
            displayRecords();
        }
        
        function exportRecords() {
            if (records.length === 0) {
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„è®°å½•');
                return;
            }
            
            // è·å–ä»Šå¤©çš„æ—¥æœŸ
            const today = new Date().toISOString().split('T')[0];
            
            // æŒ‰ç­çº§åˆ†ç»„
            const classes = {};
            studentList.forEach(student => {
                if (!classes[student.className]) {
                    classes[student.className] = [];
                }
                classes[student.className].push(student);
            });
            
            // åˆ›å»ºExcelå·¥ä½œç°¿
            const wb = XLSX.utils.book_new();
            
            // åˆ›å»ºç­¾åˆ°è®°å½•è¡¨
            const recordsData = [
                ["ç­çº§", "å§“å", "å­¦å·", "ç­¾åˆ°æ—¶é—´"]
            ];
            
            records.forEach(record => {
                recordsData.push([
                    record.className,
                    record.name,
                    record.studentId,
                    new Date(record.timestamp).toLocaleString()
                ]);
            });
            
            const recordsSheet = XLSX.utils.aoa_to_sheet(recordsData);
            XLSX.utils.book_append_sheet(wb, recordsSheet, "ç­¾åˆ°è®°å½•");
            
            // åˆ›å»ºè€ƒå‹¤ç»Ÿè®¡è¡¨
            const attendanceData = [
                ["ç­çº§", "å§“å", "å­¦å·"]
            ];
            
            // è·å–æ‰€æœ‰ç­¾åˆ°æ—¥æœŸ
            const signinDates = [...new Set(records.map(record => 
                record.timestamp.substring(0, 10)
            ))].sort();
            
            // æ·»åŠ æ—¥æœŸåˆ—æ ‡é¢˜
            signinDates.forEach(date => {
                attendanceData[0].push(date + "æ˜¯å¦åˆ°è¯¾");
            });
            
            // æŒ‰ç­çº§å¤„ç†è€ƒå‹¤
            for (const className in classes) {
                const classStudents = classes[className];
                
                classStudents.forEach(student => {
                    const row = [student.className, student.name, student.studentId];
                    
                    // å¯¹æ¯ä¸ªæ—¥æœŸæ£€æŸ¥ç­¾åˆ°æƒ…å†µ
                    signinDates.forEach(date => {
                        // æ£€æŸ¥è¯¥å­¦ç”Ÿåœ¨è¯¥æ—¥æœŸæ˜¯å¦ç­¾åˆ°
                        const studentSignins = records.filter(record => 
                            record.studentId === student.studentId && 
                            record.timestamp.startsWith(date)
                        );
                        
                        if (studentSignins.length > 0) {
                            // åŒä¸€å°æ—¶åªè®°å½•ä¸€æ¬¡
                            const uniqueHours = [...new Set(studentSignins.map(record => 
                                record.timestamp.substring(11, 13)
                            ))];
                            row.push(uniqueHours.length > 0 ? "åˆ°è¯¾" : "æœªä¸Šè¯¾");
                        } else {
                            // æ£€æŸ¥è¯¥ç­çº§åœ¨è¯¥æ—¥æœŸæ˜¯å¦æœ‰è¶…è¿‡6äººç­¾åˆ°
                            const classSignins = records.filter(record => 
                                record.className === className && 
                                record.timestamp.startsWith(date)
                            );
                            
                            // åŒä¸€å°æ—¶åªè®°å½•ä¸€æ¬¡
                            const uniqueClassSignins = [...new Set(classSignins.map(record => 
                                record.studentId + record.timestamp.substring(11, 13)
                            ))];
                            
                            if (uniqueClassSignins.length >= 6) {
                                row.push("æ—·è¯¾");
                            } else {
                                row.push("æœªä¸Šè¯¾");
                            }
                        }
                    });
                    
                    attendanceData.push(row);
                });
            }
            
            const attendanceSheet = XLSX.utils.aoa_to_sheet(attendanceData);
            
            // è®¾ç½®å•å…ƒæ ¼æ ·å¼
            if (attendanceData.length > 1) {
                for (let i = 1; i < attendanceData.length; i++) {
                    for (let j = 3; j < attendanceData[i].length; j++) {
                        const cellAddress = XLSX.utils.encode_cell({r: i, c: j});
                        if (!attendanceSheet[cellAddress]) attendanceSheet[cellAddress] = {};
                        if (!attendanceSheet[cellAddress].s) attendanceSheet[cellAddress].s = {};
                        
                        if (attendanceData[i][j] === "æ—·è¯¾") {
                            attendanceSheet[cellAddress].s = {
                                font: { color: { rgb: "FF0000" }, bold: true },
                                alignment: { horizontal: "center" }
                            };
                        } else if (attendanceData[i][j] === "æœªä¸Šè¯¾") {
                            attendanceSheet[cellAddress].s = {
                                font: { color: { rgb: "95a5a6" }, bold: true },
                                alignment: { horizontal: "center" }
                            };
                        } else {
                            attendanceSheet[cellAddress].s = {
                                alignment: { horizontal: "center" }
                            };
                        }
                    }
                }
            }
            
            // è®¾ç½®åˆ—å®½
            const colWidths = [
                { wch: 20 }, // ç­çº§
                { wch: 10 }, // å§“å
                { wch: 12 }  // å­¦å·
            ];
            
            // ä¸ºæ¯ä¸ªæ—¥æœŸåˆ—è®¾ç½®å®½åº¦
            for (let i = 0; i < signinDates.length; i++) {
                colWidths.push({ wch: 15 });
            }
            
            attendanceSheet['!cols'] = colWidths;
            
            // è®¾ç½®æ‰€æœ‰å•å…ƒæ ¼å±…ä¸­
            const range = XLSX.utils.decode_range(attendanceSheet['!ref']);
            for (let row = range.s.r; row <= range.e.r; row++) {
                for (let col = range.s.c; col <= range.e.c; col++) {
                    const cellAddress = XLSX.utils.encode_cell({r: row, c: col});
                    if (!attendanceSheet[cellAddress]) attendanceSheet[cellAddress] = {};
                    if (!attendanceSheet[cellAddress].s) attendanceSheet[cellAddress].s = {};
                    if (!attendanceSheet[cellAddress].s.alignment) {
                        attendanceSheet[cellAddress].s.alignment = { horizontal: "center" };
                    }
                }
            }
            
            XLSX.utils.book_append_sheet(wb, attendanceSheet, "è€ƒå‹¤ç»Ÿè®¡");
            
            // å¯¼å‡ºExcelæ–‡ä»¶
            XLSX.writeFile(wb, `ç­¾åˆ°è®°å½•_${today}.xlsx`);
        }
        
        function clearRecords() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç­¾åˆ°è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                records = [];
                localStorage.setItem('signinRecords', JSON.stringify(records));
                updateStats();
                displayRecords();
                alert('è®°å½•å·²æ¸…ç©º');
            }
        }
        
        window.onload = init;
        
        // è‡ªåŠ¨åˆ·æ–°è®°å½•
        setInterval(() => {
            refreshRecords();
        }, 5000);
    </script>
</body>
</html>